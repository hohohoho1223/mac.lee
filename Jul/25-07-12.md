# 오늘 내가 배운 것들(Today I Learned)

- 친구들이랑 1박으로 영종도 다녀왔다.
- 하지만 개발을 멈출순 없는법...

---

- 아래와 같이 챗봇 답변에서 에러 발생

![Image.png](https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/7A7C601D-CA9F-48FC-BDA6-6E2E8364B1EA_2/zHPmNNXOk55xlXCpCVqvL3UoKDZG4kqzuwHIet6ZkEYz/Image.png)

- 기존 코드는 JSON 파싱이 실패하면 바로 에러가 발생했음

```python
# 기존 코드 (문제 있음)
parsed_temp = json.loads(json_str)  # 실패하면 바로 에러
parsed_data = base_parser.parse(json.dumps(parsed_temp))  # 실패하면 바로 에러
```

- 발생했던 문제들
  - LLM 응답 불일치: 프롬프트에서 JSON 형식으로 요청했지만 LLM이 단순 텍스트로 응답
  - vLLM 서버문제: 토큰 생성 과정에서 JSON 구조가 꺠지는 경우
  - 네트워크 문제: 전송 중 데이터 손실로 불환전한 JSON
  - `’str' object does not support item assignment`  에러: JSON이 아닌 문자열을 딕셔너리로 접근하려고 할 때 발생
- 해결책: 3단계 fallback 시스템 구현:

  - 1단계: JSON 파싱 시도

```python
try:
    parsed_temp = json.loads(json_str)
    # json 문자열을 Python 딕셔너리로 변환
    # 성공하면 다음 단계로
except json.JSONDecodeError as json_error:
    # 실패하면 fallback으로 전체 응답을 recommend로 사용
    parsed_data = {
        "recommend": full_response.strip(),
        "challenges": []
    }
```

  - 2단계: Parser 파싱 시도

```python
try:
    parsed_data = base_parser.parse(json.dumps(parsed_temp))
    # 성공하면 정상 처리
except Exception as parse_error:
    # 실패하면 기본 구조로 변환
    if isinstance(parsed_temp, dict):
        parsed_data = {
            "recommend": parsed_temp.get("recommend", "챌린지를 추천합니다."),
            "challenges": parsed_temp.get("challenges", [])
        }
```

  - 3단계: 완전한 fallback

```python
else:
    # 모든 파싱이 실패한 경우
    parsed_data = {
        "recommend": "챌린지를 추천합니다.",
        "challenges": []
    }
```

- 개선 후: JSON 파싱 실패 시에도 안전한 fallback으로 정상 응답
