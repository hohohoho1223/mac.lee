# 오늘 내가 배운 것들(Today I Learned)

- Prometheus 메트릭 수집코드 추가하였다.

---

- `monitoring_router.py`  
- 코드 추가

## 1. Counter 메트릭 정의

```python
api_requests_total = Counter(
    'api_requests_total', 'Total number of API requests',
    ['endpoint', 'method', 'status_code']
)
```

- Prometheus Counter: API 요청 수를 세는 메트릭
  - 라벨: endpoint, method, status_code로 세분화된 카운팅
  - 예: /chat 엔드포인트의 POST 요청 중 200 상태코드 요청 수

## 2. 미들웨어 함수

```python
async def metrics_middleware(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time

    model_inference_duration_seconds.observe(duration)
    # 요청 수 카운트
    api_requests_total.labels(
        endpoint=request.url.path,
        method=request.method,
        status_code=response.status_code
    ).inc()
    return response
```

- 동작 과정:

1. 요청 시작 시간 기록
2. 실제 요청 처리 (call_next(request))
3. 응답 시간 계산
4. 메트릭 기록:
    - 추론 시간을 히스토그램에 기록
    - API 요청 수를 카운터에 증가

## 3. 수집되는 메트릭들

### API 요청 통계:

- 총 요청 수
- 엔드포인트별 요청 수
- HTTP 메서드별 요청 수
- 상태코드별 요청 수

### 성능 메트릭:

- model_inference_duration_seconds: AI 모델 추론 시간 분포

## 4. 사용 목적

- 모니터링: API 사용량과 성능 추적
- 알림: 비정상적인 요청 패턴 감지
- 대시보드: Grafana 등에서 시각화
- 성능 분석: 느린 엔드포인트 식별