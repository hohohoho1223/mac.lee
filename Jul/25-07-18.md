# 오늘 내가 배운 것들(Today I Learned)


- 테스트를 할 때 아래와 똑같은 요청을 보내고 있는데

```plaintext
curl -N "http://35.216.10.188:8000/ai/chatbot/recommendation/base-info?sessionId=user456&location=%EB%8F%84%EC%8B%9C&workType=%ED%98%84%EC%9E%A5%EC%A7%81&category=%EB%B9%84%EA%B1%B4"
```

![Image.png](https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/58889E26-4D95-4037-8953-E2F51F33D058_2/5cuC6iOiLoWAuXXMNe4ab3hzaWTCbHoKuUP6JKHkSWYz/Image.png)

- `Prefix cache hit rate` 값이 49.1 → 73.7% 까지 상승하는 모습을 볼 수 있다.
- 여기서 궁금증이 생겼다.
  - “똑같은 요청을 보낼 수록 캐시를 써서 답변 속도가 빨라진다는거야? KV캐시랑은 관련없음? 내가 알기론 KV캐시가 이전 토큰 기억해서 더 빠르게 추론하는것 같은데”

### 답변:

Prefix cache(프리픽스 캐시)와 KV cache(키-밸류 캐시)는 서로 다른 개념이지만, 둘 다 LLM 추론 속도를 높이기 위해 사용되는 캐시이다.

## 1. Prefix Cache (프리픽스 캐시)란?

- 동일한 프롬프트(입력 prefix)가 여러 번 들어올 때, 이미 계산된 중간 결과(Attention Key/Value 등)를 재사용하는 캐시

- 예를 들어,

```plaintext
[INST] ...질문1... [/INST]
[INST] ...질문2... [/INST]
```

- 이런 식으로 프롬프트 앞부분이 똑같은 요청이 반복되면

  → 프리픽스 부분의 연산을 다시 하지 않고 캐시에서 꺼내서 바로 사용
  → 속도 대폭 향상

- Prefix cache hit rate가 높을수록

- 동일/유사 프롬프트가 많이 들어와서 캐시 재사용이 잘 되고 있다는 뜻 & 실제 답변 생성 속도(throughput)가 빨라짐

---

## 2. KV Cache (Key-Value 캐시)란?

- LLM의 Attention 연산에서, 이미 생성된 토큰의 Key/Value를 GPU 메모리에 저장해두고
  - 다음 토큰 생성 시 다시 계산하지 않고 재사용
  - 긴 문장 생성 시 속도/메모리 효율 극대화

- KV cache usage는
  - 현재 GPU에 저장된 Key/Value 캐시의 사용량(%)
  - 동시 요청이 많거나, 긴 문장 생성 시 높아짐

## 3. 둘의 관계와 차이

| **구분**  | **Prefix Cache**      | **KV Cache**       |
| ------- | --------------------- | ------------------ |
| 목적      | 동일 프롬프트 재사용           | 한 요청 내에서 토큰 생성 가속  |
| 범위      | 여러 요청 간(넓음)           | 한 요청 내(좁음)         |
| 효과      | 반복 프롬프트 속도 향상         | 긴 문장/동시 요청 속도 향상   |
| vLLM 로그 | Prefix cache hit rate | GPU KV cache usage |

- Prefix cache:

> 여기서 말하는 "prefix"는 "프롬프트(입력 문장)의 앞부분"을 의미

> "이전에 봤던 프롬프트라면, 그 부분은 통째로 캐시에서 꺼내서 바로 이어서 생성"

- KV cache:

> ”한 번 생성한 토큰의 Key/Value는 다음 토큰 생성 때 또 쓰니까 GPU에 저장"

## 4. 실제 효과

- 동일한 요청을 반복해서 보내면

- Prefix cache hit rate가 점점 올라감

- 답변 생성 속도(Avg generation throughput)가 빨라짐

- KV cache는 항상 사용

  - 요청이 많아지면 usage가 올라가고,

  - 너무 많으면 GPU 메모리 부족으로 속도 저하/에러 가능

## 5. 정리

- Prefix cache:

> "동일 프롬프트 반복 시 전체 연산을 캐시로 대체 → 속도 향상"

- KV cache:

> "한 요청 내에서 토큰 생성 시 이전 토큰의 정보를 저장/재사용 → 필수 캐시"

- 현재 멀트태스킹 파인튜닝을 진행하고 있으므로, 각 “instruction”에 맞게끔 프롬프트 설계를 해야 모델이 파인튜닝때 배운 문맥/출력 스타일 그대로 출력한다

---

- 약 2300개 데이터셋으로 파인튜닝한 결과…

![Image.png](https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/78CF36BC-2FE4-4506-8A6F-4AF5C1E41941_2/CoBUfLvpIwxllofC2WVBNH5dfSY6xweeK8xMOPLKyykz/Image.png)

- 이상하다 답변이…
  - 파인튜닝이 문제인걸까

- 프롬프트를 재수정함

+ 아래는 프롬프트 내용이다.

```plaintext
    input_variables=["location", "workType", "category", "escaped_format"],
    template=""""너는 챌린지 추천 챗봇이야.
        "사용자가 선택한 '위치, 직업, 카테고리'에 맞춰 구체적인 친환경 챌린지 3가지를 JSON 형식으로 추천해줘.\n"
        "input: {location}, {workType}, {category}\n"
        "output:"
        JSON 포맷:
        {escaped_format}

        반드시 위 JSON 형식 그대로 반드시 한글로 한번만 출력하세요.
    """
```

- 출력 결과

![Image.png](https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/C7F0A7CC-492A-45A4-A970-6B849E2BA6E6_2/Ff3fNPRXYViSA7AWf0aIlyDjniP3KtgoOqqYnF5xiE0z/Image.png)

- 일단 답변 형태는 잘 나온다 굳 
- 근데 “output"에서 역슬래쉬 “\” 를 출력한다.
  - 학습 데이터를 "문자열 안에 JSON을 한 줄로 안전하게 넣으려고" 하다가 출력
