# 오늘 내가 배운 것들(Today I Learned)

- 피드백 내용이 짤린다ㅠㅠ

---

### 문제

<p align="center">
<img src="https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/41ceb31e-d254-ba0f-c4aa-293f7bf054ec/LuFwOFT9zuA5hpXgtzxoQacNuFnPhtCCUOraKRzeqygz/Image.png" alt ="Image.png"/>
</p>

- 피드백 생성 결과에 프롬프트까지 함께 출력되는 문제는, 모델의 출력에서 프롬프트와 생성된 답변이 모두 포함되어 있기 때문

```python
full_feedback = self.tokenizer.decode(outputs[0], skip_special_tokens=True)
```

### 해결

1. 프롬프트 길이 만큼을 잘라내고, 그 이후의 텍스트를 추출
    - 프롬프트의 토큰 길이를 구한다
    - 모델 출력의 토큰 시퀀스에서 프롬프트 길이 이후의 토큰만 디코딩
    - 아래는 수정 코드이다

```python
try:
    # Mistral 모델을 통한 피드백 생성
    inputs = self.tokenizer(prompt, return_tensors="pt").to(self.model.device)
    prompt_length = inputs["input_ids"].shape[1]  # 프롬프트 토큰 길이
    outputs = self.model.generate(
        **inputs,
        max_new_tokens=self.max_tokens,
        temperature=0.7,
        do_sample=True,
        pad_token_id=self.tokenizer.eos_token_id
    )
    # 생성된 전체 시퀀스에서 프롬프트 이후 부분만 디코딩
    generated_ids = outputs[0][prompt_length:]
    full_feedback = self.tokenizer.decode(generated_ids, skip_special_tokens=True)
```

- `skip_special_tokens` 은 디코딩 스킵 처리 (<s>, </s>, <pad>, <unk> 등)

# 근데 어떻게 프롬프트의 토큰 길이를 알 수 있는걸까?

- `prompt_length = inputs["input_ids"].shape[1]`
- 프롬프트를 토크나이저에 넣으면

```python
inputs = self.tokenizer(prompt, return_tensors="pt")
```

- `inputs[“input_ids”]` 는 프롬프트 전체를 토큰화한 결과
- `ìnputs[“input_ids”]` 의 shape
  - 이 값은 shape가 (batch_size, sequence_length) 이다
    - batch_size: 한 번에 몇 개의 문장을 토큰화 하는지
    - sequence_length: 프롬프트의 토큰 개수
  - 그래서 `inputs["input_ids"].shape[1]` 요게 프롬프트의 토큰 개수다 이 말씀

### `generated_ids = outputs[0][prompt_length:]` 이건 뭘까?

- 여기서 outputs는 토치(Torch) 텐서 또는 넘파이 배열 형태로 변환 된다.
  - 일반적으로 outputs의 shape은: (batch_size, 전체 시퀀스(토큰) 길이)
- “outputs[0]” 의 의미?
  - 배치에서 첫번째 샘플의 토큰 시퀀스를 의미
  - 즉, outpust[0]은 -> [프롬프트 토큰들... , 생성된 토큰들...] 이고,  `outputs[0][prompt_length:]` ->생성된 토큰들만 슬라이싱

### 프롬프팅 수정

```python
self.prompt_template = os.getenv("FEEDBACK_PROMPT_TEMPLATE",
        """
        다음 {personal_challenges}와 {group_challenges} 기록을 통합하여 요약하고, 사용자의 노력을 인정하고 격려하는 피드백을 한글로 생성해주세요.
        실패한 챌린지에 대해서는 위로와 함께 다음 기회를 기대한다는 메시지를 포함해주세요.
        유니코드(Unicode) 표준에 포함된 이모지(예: 😊, 🌱, 🎉 등)를 적절히 사용하여 친근하고 밝은 톤으로 작성해주세요.
        같은 의미의 문장을 반복하지 말고, 구체적이고 간결하게 작성하세요.
        문장이 중간에 끊기지 않게 완결된 문장으로 작성하세요.
        전체 답변은 한글 기준 250자 이내로 작성하세요.

        개인 챌린지:
        {personal_challenges}

        단체 챌린지:
        {group_challenges}
        """)
```

- `self.max_tokens` 값을 200 -> 250으로 증가
  - 답변이 중간에 짤리는 현상 방지 목적