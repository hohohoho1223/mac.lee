# 오늘 내가 배운 것들(Today I Learned)

### 1. 파싱오류

- 파싱 오류가 났다.(/free-text)

  - “Expecting ',' delimiter: line 1 column 362 (char 361)”

  - 파서가 **배열 내 다음 요소를 기대했지만**, **문자열만 나오고 JSON이 중단된 상황**( “]”이걸로 제대로 안닫힘)

### 해결방안

- 문자열 추출 시
  - “json_match = re.search(r"`json\n([\s\S]*?)\n`", full_response)”에서
  - "json_match = re.search(r"`json\n([\s\S]*?)\n`", full_response.strip())”로변경
  - 왜 바꿨는가?
  - 아래 출력과 같이, 감싸기 때문이다

````plaintext
\n```json\n{...JSON...}\n```\n
````

- 따라서  맨 앞/뒤 개행 때문에 정규식 매칭이 **실패할 수 있음**
  - 그래서 `.strip()` 으로 선/후 개형을 버린것

### 2. 줄바꿈 개선

- 피드백 모델은 줄바꿈이 잘 들어간 것을 볼 수 있음.  

![Image.png](https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/780049C8-7E88-4365-BE97-71106987403F_2/XcD9NfLfX5dPXmJUauYsc8mv7QTxgwkVfZ2ihX99Hvwz/Image.png)

- 근데 왜 챗봇의 답변은 줄바꿈이 안일어 날까?(심지어 프롬프트에 줄바꿈 요청을 했는데도)
  - personal_challenges, group_challenges는 이미 Python 코드에서 \n 줄바꿈 포함한 문자열로 들어가고, → 모델은 이를 학습된 형태 그대로 이해하고 **자연스럽게 줄바꿈 포함된 응답을 생성한다.**
  - 즉, 알아서 학습된 형태로? 자연스럽게 줄바꿈 형태를 넣어서 답변 해준다는 말
- 이유는 두가지가 있음

1. **Python 포맷팅 코드에서 실제 줄바꿈 문자 \n을 사용하고 있음**

- 예시 (LLM_feedback_model.py):

```python
formatted.append(
    f"- {challenge['title']}\n"
    f"  기간: {challenge['startDate']} ~ {challenge['endDate']}\n"
    f"  최근 일주일 성공률: {success_count}/{total_count}"
)
```

- 이 부분에서 프롬프트에 **실제 줄바꿈 문자 (\n)** 가 삽입
- 즉, 결과적으로 프롬프트 안에는 다음과 같이 들어감:

```python
개인 챌린지:
- 텀블러 사용 챌린지 (성공)
- 제로웨이스트 실천 (실패)

단체 챌린지:
- 분리수거 캠페인
  기간: 2025-06-01 ~ 2025-06-10
  최근 일주일 성공률: 3/4
```

2. **프롬프트에 \n처럼 “줄바꿈을 문자로 출력하라”는 제약이 없음**
    -  ? base-info / free-text에서는 프롬프트에서 \n으로 출력하라고 명시적으로 지시하는게 잘못 됐나봄
        - 그래서 모델은 진짜 개행이 아니라 "\n"이라는 텍스트 자체를 출력함 → 줄바꿈 **안 됨**
    - 문자 스트링 후처리 때문에 \\n이 제외되는것 같았다. (너무 쳐내서)

#### 해결방안

- 아래와 같은 코드로 바꿔보자(아직 미정)

```python
try:
    for new_text in streamer:
        # 새 로직: 유니코드 이스케이프 해제 및 예외 안전 처리
        if new_text and not response_completed:
            full_response += new_text
            logger.info(f"토큰 수신: {new_text[:20]}...")

            # 유니코드 이스케이프 해제 (예: \\n → 실제 줄바꿈)
            try:
                cleaned_text = new_text.encode('utf-8').decode('unicode_escape')
            except Exception as e:
                logger.warning(f"이스케이프 디코딩 실패: {e}")
                cleaned_text = new_text  # fallback

            # SSE 응답 전송
            try:
                yield {
                    "event": "challenge",
                    "data": json.dumps({
                        "status": 200,
                        "message": "토큰 생성",
                        "data": cleaned_text
                    }, ensure_ascii=False)
                }
            except Exception as e:
                logger.error(f"이벤트 전송 중 에러 발생: {str(e)}")
                response_completed = True
                continue
```

---

#### 중간에 또다시 오류가 발생...!

<p align="center">
<img src="https://resv2.craft.do/user/full/641ffdb9-6693-37da-6dbd-e78e1756c2de/doc/3c17d71c-25ef-2249-36c5-6ac2c9747d25/0666D18C-43A0-46B8-ADB7-7F847546D842_2/akyDo04XQhqBl2juea3Fdgzty54tGdtEUHDAUdWrcxgz/Image.png" alt="Image.png"/>
 </p>

#### 이젠 너무 많이 봐서 지긋지긋 하다ㅋ

- 그니까 정리하자면 마지막까지 파싱잘하고 "event: close” 로 yield해서 SSE 연결 끝마쳤는데, 뒤에 또 이상한 요청이 들어와서 그럼ㅋ

> ASGI "이미 응답이 끝났는데 또 데이터를 보내려고 한다”: 에러 발생

- 뒤에 예외 상황이 발생했거나, 루프가 돌면서 except블록이 실행됐다거나 등등
- 그래서 그냥 200뜨면~ return 박기로함

```python
yield {
    "event": "close",
    "data": json.dumps({
        "status": 200,
        "message": "모든 챌린지 추천 완료",
        "data": final_data
    }, ensure_ascii=False)
}
return
```

- 아 몰론 free-text 핸들러에도 적용함
